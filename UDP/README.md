## UDP 知识点

UDP 是无连接的用户数据报协议，端与端之间不需要建立连接，会发生丢包、乱序等情况。

应用程序必须关心 IP 数据报的长度，如果它超过了 MTU(以太网对数据帧的长度有一个限制，最大值是 1500，最大传输单元)，就要对 IP 数据报进行分片。

### UDP 首部

![](https://github.com/steveLauwh/TCP-IP/raw/master/TCP/image/udpheader.png)

IP 数据报的最大长度时 65535 字节，这是由 IP 首部 16 比特总长度字段所限制的。除去 20 字节的 IP 首部和 8 字节的 UDP 首部，UDP 数据报中用户数据的最长长度为 65507 字节。

### UDP 调用 connect 函数的作用

UDP 网络编程中可以调用 connect 函数，但它仅仅用于表示确定了另一方的地址和端口，并没有其他含义。

UDP 可以多次调用 connect，TCP 只能调用一次 connect。

对于未连接的套接字，也就是我们常用的的 UDP 套接字，我们使用的是 sendto/recvfrom 进行信息的收发，目标主机的 IP 和端口是在调用 sendto/recvfrom 时确定的。

采用 connect 方式的 UDP 发送两个报文内核如下处理:
* 建立连结
* 发送报文
* 发送报文， 每次发送报文内核都由可能要做路由查询

UDP 使用 connect 可以提高效率，高并发服务中会增加系统稳定性。

### UDP 报文丢失问题

如果客户端发送的数据丢失，服务器会一直等待，直到客户端的合法数据过来。

如果服务器的响应在中间被路由丢弃，则客户端会一直阻塞，直到服务器数据过来。

防止这样的永久阻塞的一般方法是给客户的 recvfrom 调用设置一个超时。

### UDP 报文乱序问题

所谓乱序就是发送数据的顺序和接收数据的顺序不一致。

UDP 协议并不保证数据报的按序接收。

解决这个问题的方法就是发送端在发送数据时加入数据报序号，这样接收端接收到报文后可以先检查数据报的序号，并将它们按序排队，形成有序的数据报。

### UDP 流量控制问题

TCP 有滑动窗口进行流量控制和拥塞控制，反观 UDP 因为其特点无法做到。

UDP 接收数据时直接将数据放进缓冲区内，如果用户没有及时将缓冲区的内容复制出来放好的话，后面到来的数据会接着往缓冲区放，当缓冲区满时，后来到的数据就会覆盖先来的数据而造成数据丢失（因为内核使用的 UDP 缓冲区是环形缓冲区）。
因此，一旦发送方在某个时间点爆发性发送消息，接收方将因为来不及接收而发生信息丢失。

解决方法一般采用增大 UDP 缓冲区，使得接收方的接收能力大于发送方的发送能力。

## UDP 应用场景

UDP 不为 IP 提供可靠性、流量控制或差错恢复功能，所以 UDP 对应的则是可靠性要求低、传输流量大，传输速度快的应用。

一些知名的应用层协议（SNMP 简单网络管理协议、DNS）都是基于UDP的。

* 面向数据报方式
* 网络数据大多为短消息 
* 拥有大量 Client
* 对数据安全性无特殊要求
* 网络负担非常重，但对响应速度要求高

## 参考资料

* [TCP和UDP的最完整的区别](http://blog.csdn.net/li_ning_/article/details/52117463)

