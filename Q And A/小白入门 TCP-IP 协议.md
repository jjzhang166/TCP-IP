## 小白入门 - TCP/IP 协议

宏观认识互联网通信，值得反复看的四篇文章，佩服作者的文字功底、理解和总结能力。

* [互联网协议入门(一)](http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html)
* [互联网协议入门(二)](http://www.ruanyifeng.com/blog/2012/06/internet_protocol_suite_part_ii.html)
* [TCP 协议简介](http://www.ruanyifeng.com/blog/2017/06/tcp-protocol.html)
* [HTTP 协议入门](http://www.ruanyifeng.com/blog/2016/08/http.html)

## Q & A

**1. Link Layer 数据链路层**

以太网规定，一组电信号构成一个数据包，叫做"帧"（Frame）。每一帧分成两个部分：标头（Head）和数据（Data）。

"标头"的长度，固定为 18 字节。"数据"的长度，最短为 46 字节，最长为 1500 字节。因此，整个"帧"最短为 64 字节，最长为 1518 字节。如果数据很长，就必须分割成多个帧进行发送。

网卡的地址，就是数据包的发送地址和接收地址，这叫做 MAC 地址。MAC 地址是唯一的，长度是 48 个二进制位，通常用 12 个十六进制数表示。

广播：针对子网络来说，向本网络内所有计算机发送(接收方的 MAC 地址)，让每台计算机自己判断，是否为接收方。

-----

**2. Network Layer 网络层**

不同的子网络，通过 "路由"(如何向不同的子网络分发数据包)方式发送。

网络地址(IP 地址)：区分不同的计算机是否属于同一个子网络。

任意两个 IP 地址是否处在同一个子网络：将两个 IP 地址和子网掩码(subnet mask)分别进行 AND 运算，如果相同，表示为同一子网络。

IP 数据包的 "标头" 部分的长度为 20 到 60 字节，整个数据包的总长度最大为 65535 字节。因此，理论上，一个 IP 数据包的 "数据" 部分，最长为 65515 字节。

ARP 协议：两台主机在同一个子网络，可以用 ARP 协议，得到对方的 MAC 地址。

--------

**3. Transport Layer 传输层**

"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。

UDP 数据包非常简单，"标头"部分一共只有 8 个字节，总长度不超过 65535 字节，正好放进一个 IP 数据包。

TCP 数据包和 UDP 数据包一样，都是内嵌在 IP 数据包的"数据"部分。TCP 数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常 TCP 数据包的长度不会超过 IP 数据包的长度，以确保单个 TCP 数据包不必再分割。

---------

**4. Application Layer 应用层**

"应用层"的作用，就是规定应用程序的数据格式。

-------

**5. 网络通信的本质**

就是交换数据包，发送数据包需要知道对方的 MAC 地址和 IP 地址。

如果两台电脑不在同一个子网络，就无法知道对方的 MAC 地址，必须通过 网关（gateway）转发。

| 场景        | 数据包地址   | 
| --------   | -----:  | 
| 同一个子网络     | 对方的MAC地址，对方的IP地址 |  
| 非同一个子网络       |   网关的MAC地址，对方的IP地址   |  

-------

**6. DHCP 协议**

所谓"动态 IP 地址"，指计算机开机后，会自动分配到一个 IP 地址，不用人为设定。它使用的协议叫做 DHCP 协议。

DHCP 是一个应用层协议，建立在 UDP 协议之上。

UDP 标头的端口是67（发出方）和68（接收方）。

这个协议规定，每一个子网络中，有一台计算机负责管理本网络的所有 IP 地址，它叫做"DHCP服务器"。新的计算机加入网络，必须向"DHCP服务器"发送一个"DHCP请求"数据包，申请 IP 地址和相关的网络参数。

-------

**7. 上网设置的参数**

* 本机的 IP 地址
* 子网掩码
* 网关的 IP 地址
* DNS 的 IP 地址

DNS 协议的作用：配置 DNS 的 IP 地址(DNS 服务器)，当我们在浏览器输入网址，我们会向 DNS 服务器发送一个 DNS 包(53端口，建立在 UDP 协议之上)，DNS 服务器做出响应，告诉输入网址的 IP 地址，也就是对方的 IP 地址。

-------

**8. HTTP/1.0 keep-alive**

HTTP/1.0 版的主要缺点是，每个 TCP 连接只能发送一个请求。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。

为了解决这个问题，有些浏览器在请求时，用了一个非标准的 Connection 字段 keep-alive，这个字段要求服务器不要关闭 TCP 连接，以便其他请求复用。

一个可以复用的 TCP 连接就建立了，直到客户端或服务器主动关闭连接。

-------

**9. HTTP/1.1 特点**

> **持久连接**

HTTP/1.1 版引入了持久连接（persistent connection），即 TCP 连接默认不关闭，可以被多个请求复用，不用声明 Connection: keep-alive 字段。

客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。不过，规范的做法是，客户端在最后一个请求时，发送 Connection: close，明确要求服务器关闭 TCP 连接。

目前，对于同一个域名，大多数浏览器允许同时建立 6 个持久连接。

> **管道机制**

在同一个 TCP 连接里面，客户端可以同时发送多个请求。这样就进一步改进了 HTTP 协议的效率。

管道机制是允许浏览器同时发出 A 请求和 B 请求，但是服务器还是按照顺序，先回应 A 请求，完成后再回应 B 请求。

> **Content-Length 字段**

一个 TCP 连接现在可以传送多个回应，势必就要有一种机制，区分数据包是属于哪一个回应的。这就是 Content-length 字段的作用，声明本次回应的数据长度。

> **分块传输编码**

HTTP 1.1 版规定可以不使用 Content-Length 字段，而使用"分块传输编码"（chunked transfer encoding）。只要请求或回应的头信息有 Transfer-Encoding 字段，就表明回应将由数量未定的数据块组成。

> **HTTP/1.1 的缺点**

虽然 HTTP/1.1 版允许复用 TCP 连接，但是同一个 TCP 连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。

要是前面的回应特别慢，后面就会有许多请求排队等着。这称为"队头堵塞"（Head-of-line blocking）。

为了避免这个问题，只有两种方法：一是减少请求数，二是同时多开持久连接。

-------

**10. HTTP/2 特点**

> **二进制协议**

一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为"帧"（frame）：头信息帧和数据帧。

二进制协议的一个好处是，可以定义额外的帧。

> **多工**

HTTP/2 复用 TCP 连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序一一对应，这样就避免了"队头堵塞"。

这样双向的、实时的通信，就叫做多工（Multiplexing）。

> **数据流**

HTTP/2 将每个请求或回应的所有数据包，称为一个数据流（stream）。每个数据流都有一个独一无二的编号。数据包发送的时候，都必须标记数据流 ID，用来区分它属于哪个数据流。另外还规定，客户端发出的数据流，ID 一律为奇数，服务器发出的，ID 为偶数。

客户端还可以指定数据流的优先级。优先级越高，服务器就会越早回应。

> **头信息压缩**

HTTP 协议不带有状态，每次请求都必须附上所有信息。所以，请求的很多字段都是重复的，比如 Cookie 和 User Agent，一模一样的内容，每次请求都必须附带，这会浪费很多带宽，也影响速度。

HTTP/2 对这一点做了优化，引入了头信息压缩机制（header compression）。一方面，头信息使用 gzip 或 compress 压缩后再发送；另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。

> **服务器推送**

HTTP/2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。
