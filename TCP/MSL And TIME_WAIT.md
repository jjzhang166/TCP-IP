## MSL

MSL(Maximum Segment Lifetime)：报文段最大生存时间，表示任何报文在网络上存在的最长时间，超过这个时间，报文将被丢弃。

RFC 973指定 MSL 为 2 分钟，然而，在实现中的常用值是 30s，1分钟 和 2分钟。

在 2MSL 的时间内，该地址上的连接不能被使用(客户端的地址、端口和服务器端的地址、端口)。比如在建立一个连接后关闭连接然后迅速重启连接，那么就会出现端口不可用的情况。

## TIME_WAIT

在 TCP 的状态图中，从 TIME_WAIT 态到 CLOSED 态，有一个超时设置 `2*MSL`，为什么需要有 TIME_WAIT 态，为什么不直接转成 CLOSED 态？

主要原因两个：

(1) 可靠地实现 TCP 全双工连接的终止

TCP 四次挥手操作，最后的 ACK 是由主动关闭端发出的，然后主动关闭端进入 TIME_WAIT 态，起个 `2*MSL` 时间，用来保证 ACK 能被 被动关闭端收到，如果被动关闭端没有收到 ACK，这时候，被动关闭端重发 FIN，这样一来回刚好为 2 个 MSL。

(2) 允许老的报文段在网络上消逝

TCP 不允许在 TIME_WAIT 态的连接启动一个新的连接，因为 TIME_WAIT 态持续 `2*MSL`，这样当新建立一个连接时，前面这个连接会消逝。

## TIME_WAIT 的不好之处以及采取什么措施

**不好之处：** Linux 分配给一个用户的文件句柄是有限的，如果系统中存在大量的 TIME_WAIT 状态，一旦达到句柄数上限，新的请求就无法被处理了，而且大量 TIME_WAIT 连接占用资源影响性能。(大量 TIME_WAIT 会占用系统资源，影响性能)

**采取措施：** 在 /etc/sysctl.conf 文件中开启 net.ipv4.tcp_tw_reuse 重用和 net.ipv4.tcp_tw_recycle 快速回收。
